<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Courier+New:wght@700&display=swap" rel="stylesheet">
    <!-- Include jQuery (required for ionRangeSlider) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- Include ionRangeSlider CSS and JS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ion-rangeslider/css/ion.rangeSlider.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/ion-rangeslider/js/ion.rangeSlider.min.js"></script>

    <title>Project Lexeme</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">

</head>
<body>
<div id="header">PROJECT LEXEME</div>
<div class="container">
    <div class="tile" onclick="showLessonOptions()">
        <h2>GENERATE LESSON</h2>
        <p>Get lessons from subtitles or vocabulary</p>
    </div>
    <div class="tile" onclick="showSettingsOptions()">
        <h2>CHANGE SETTINGS</h2>
        <p>Customize your experience</p>
    </div>
    <div class="tile" onclick="showRecordOptions()">
        <h2>RECORD CONTENT</h2>
        <p>Capture screenshots and record your screen</p>
    </div>
    <div class="tile" onclick="showUploadOptions()">
        <h2>UPLOAD FILES</h2>
        <p>Upload .srt files (or maybe CSV's in the future)</p>
    </div>
    <div class="tile">
        <h2>ALSO COMING SOON</h2>
        <p>More features</p>
    </div>
    <div class="tile">
        <h2>COMING, BUT NOT SO SOON</h2>
        <p>Expand capabilities</p>
    </div>
</div>

<div id="app-configuration">
    <h3>App Configuration</h3>
    <ul>
        <li><strong>Number of Preprocessors:</strong> {{ num_processors }}</li>
        <li><strong>Tesseract Configuration:</strong> {{ tesseract_configuration }}</li>
        <li><strong>Time Between Screenshots:</strong> {{ time_between_screenshots }}</li>
        <li><strong>Base URL:</strong> {{ base_url }}</li>
        <li><strong>Model:</strong> {{ model }}</li>
        <li><strong>Language:</strong> {{ lang }}</li>
        <li><strong>Proficiency:</strong> {{ prof }}</li>
    </ul>
</div>

<div id="lesson-prompt-options">
    <div class="tile" onclick="getLessonFromSubtitles()"><h2>GET LESSON FROM SUBTITLES</h2></div>
    <div class="tile" onclick="getLessonFromVocabulary()"><h2>GET LESSON FROM VOCABULARY</h2></div>
    <div class="tile" onclick="goBack()"><h2>BACK</h2></div>
</div>

<div id="change-settings-options">
    <div class="tile" onclick="modifyConfigurationOptions()"><h2>MODIFY CONFIGURATIONS</h2></div>
    <div class="tile" onclick="viewGeneratedSubtitles()"><h2>VIEW GENERATED SUBTITLES</h2></div>
    <div class="tile" onclick="viewPromptsForLLM()"><h2>VIEW PROMPTS</h2></div>
    <div class="tile" onclick="goBack()"><h2>BACK</h2></div>
</div>

<div id="modify-configuration-options">
    <div class="tile" id="change-settings-button" onclick="changeSettings()"><h2>CHANGE CONFIGURATION VALUES</h2></div>
    <div class="tile" id="submit-settings-button" onclick="submitSettings()" style="display: none;"><h2>SUBMIT CHANGES</h2></div>
    <div class="tile" id="configuration-back-button" onclick="goBackToChangeSettingsOptions()"><h2>BACK</h2></div>
</div>

<div id="subtitle-selection">
    <div class="prompt-container">
        <span style="font-size: 20px">I WANT TO GENERATE A</span>
        <div class="dropdown-wrapper">
            <select id="prompt-type-dropdown" class="custom-dropdown"></select>
        </div>
        <span style="font-size: 20px">WITH</span>
        <div class="dropdown-wrapper">
            <select id="subtitle-dropdown" class="custom-dropdown"></select>
        </div>
    </div>
    <div class="tile generate-tile" onclick="generate()">
        <h2>GENERATE</h2>
    </div>
    <div class="tile back-tile" onclick="goBackToLessonOptions()">
        <h2>BACK</h2>
    </div>
</div>

<div id="record-content-options">
    <div class="tile" onclick="takeScreenshot()"><h2>TAKE SCREENSHOT</h2></div>
    <div class="tile" onclick="toggleScreenRecording()"><h2>BEGIN RECORDING SCREEN</h2></div>
    <div class="tile" onclick="adjustBoundingBox()"><h2>ADJUST BOUNDING BOX</h2></div>
    <div class="tile" onclick="goBack()"><h2>BACK</h2></div>
    <div class="tile" id="on-stop-recording-submit-lesson-button" style="display: none;" onclick="onStopRecordingSubmitLesson()">
        <h2>GET SUMMARY</h2>
    </div>
</div>

<div id="upload-content-options">
    <div class="tile" id="fileInputWrapper">
        <input type="file" id="fileInput" accept=".srt"  onchange="updateFileLabel(); selectSubtitleUpload();">
        <label for="fileInput" id="fileLabel">Choose a .SRT File</label>
    </div>
    <div class="tile" id="submitButton" style="display: none;" onclick="submitSubtitleUpload()">
        <h2>SUBMIT</h2> 
    </div>
    <!-- Slider container moved outside the tile but retains the tile style -->
    <div class="tile" id="sliderContainer" style="display: none;">
        <h2>Adjust the Slider</h2>
        <p>Set the value based on the uploaded file</p>
        <input type="text" id="slider" name="slider" />
    </div>
    <div class="tile" onclick="goBack()">
        <h2>BACK</h2>
    </div>
</div>

<div id="response"></div>

<script>
    var sliderInstance;

    function showAppConfiguration() {
        const appConfig = document.getElementById('app-configuration');
        appConfig.style.display = 'block';  // Show the App Configuration section
    }

    function hideAppConfiguration() {
        const appConfig = document.getElementById('app-configuration');
        appConfig.style.display = 'none';  // Hide the App Configuration section
    }

    function changeSettings(){
        const submitSettingsButton = document.getElementById('submit-settings-button');
        submitSettingsButton.style.display = 'block'; 
        const configurationBackButton = document.getElementById('configuration-back-button');
        configurationBackButton.style.display = 'none';
    }

    function submitSettings(){
        const submitSettingsButton = document.getElementById('submit-settings-button');
        submitSettingsButton.style.display = 'none';
        const configurationBackButton = document.getElementById('configuration-back-button');
        configurationBackButton.style.display = 'block';
    }
    function getLessonFromSubtitles() {
        fetch('/get-subtitle-files')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                // Populate subtitle dropdown
                const subtitleDropdown = document.getElementById('subtitle-dropdown');
                subtitleDropdown.innerHTML = ''; // Clear previous options
                data.choices.forEach(choice => {
                    const option = document.createElement('option');
                    option.value = choice;
                    option.textContent = choice;
                    subtitleDropdown.appendChild(option);
                });

                // Populate prompt type dropdown
                const promptTypeDropdown = document.getElementById('prompt-type-dropdown');
                promptTypeDropdown.innerHTML = ''; // Clear previous options
                data.prompt_types.forEach(type => {
                    const option = document.createElement('option');
                    option.value = type;
                    option.textContent = type;
                    promptTypeDropdown.appendChild(option);
                });

                // Hide lesson prompt options and show subtitle selection
                document.getElementById('lesson-prompt-options').style.display = 'none';
                document.getElementById('subtitle-selection').style.display = 'grid';
            })
            .catch(error => {
                console.error('Error fetching subtitle files:', error);
                document.getElementById('response').textContent = 'Error fetching subtitle files.';
            });
    }
    
    function modifyConfiguration() {
        fetch('/open-config-file', {
            method: 'POST'
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to open config file');
                } else {
                    document.getElementById('response').textContent = 'Modifying Configurations';
                }
            })
            .catch(error => console.error('Error:', error));
    }

    function viewGeneratedSubtitles() {
        fetch('/open-subtitles-folder', {
            method: 'POST'
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to open subtitles folder');
                } else {
                    document.getElementById('response').textContent = 'Viewing Generated Subtitles';
                }
            })
            .catch(error => console.error('Error:', error));
    }

    function viewPromptsForLLM() {
        fetch('/open-prompt-directory', {
            method: 'POST'
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to open prompt directory');
                } else {
                    document.getElementById('response').textContent = 'Opening Prompt Directory';
                }
            })
            .catch(error => console.error('Error:', error));
    }

    function generate() {
        const subtitleDropdown = document.getElementById('subtitle-dropdown');
        const promptTypeDropdown = document.getElementById('prompt-type-dropdown');

        const selectedSubtitle = subtitleDropdown.value;
        const selectedPromptType = promptTypeDropdown.value;

        fetch('/generate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                subtitle: selectedSubtitle,
                prompt_type: selectedPromptType
            })
        })
            .then(response => response.json())
            .then(data => {
                document.getElementById('response').textContent = 'Lesson generated successfully!';
                window.location.href = `/lesson?subtitle=${encodeURIComponent(selectedSubtitle)}&prompt_type=${encodeURIComponent(selectedPromptType)}`;
                // Additional handling of lesson data can be added here
            })
            .catch(error => {
                console.error('Error generating lesson:', error);
                document.getElementById('response').textContent = 'Error generating lesson.';
            });
    }

    function showSettingsOptions() {
        document.querySelector('.container').style.display = 'none';
        const settingsOptions = document.getElementById('change-settings-options');
        settingsOptions.style.display = 'grid';
    }

    function modifyConfigurationOptions() {
        document.getElementById('change-settings-options').style.display = 'none';
        showAppConfiguration();
        const configurationOptions = document.getElementById('modify-configuration-options');
        configurationOptions.style.display = 'grid';
    }

    function showRecordOptions() {
        document.querySelector('.container').style.display = 'none';
        const recordOptions = document.getElementById('record-content-options');
        recordOptions.style.display = 'grid';
    }

    function showLessonOptions() {
        document.querySelector('.container').style.display = 'none';
        const lessonOptions = document.getElementById('lesson-prompt-options');
        lessonOptions.style.display = 'grid';
    }
    function showUploadOptions() {
        document.querySelector('.container').style.display = 'none';
        const settingsOptions = document.getElementById('upload-content-options');
        settingsOptions.style.display = 'grid';
    }

    function goBack() {
        document.getElementById('lesson-prompt-options').style.display = 'none';
        document.getElementById('record-content-options').style.display = 'none';
        document.getElementById('change-settings-options').style.display = 'none';
        document.getElementById('upload-content-options').style.display = 'none';
        document.getElementById('modify-configuration-options').style.display = 'none';
        document.getElementById('response').textContent = " ";
        document.querySelector('.container').style.display = 'grid';
    }

    function goBackToLessonOptions() {
        document.getElementById('subtitle-selection').style.display = 'none';
        document.getElementById('lesson-prompt-options').style.display = 'grid';
        document.getElementById('response').textContent = " ";
    }

    function goBackToChangeSettingsOptions() {
        document.getElementById('modify-configuration-options').style.display = 'none';
        hideAppConfiguration();
        document.getElementById('change-settings-options').style.display = 'grid';
        document.getElementById('response').textContent = " ";
    }

    function getLessonFromVocabulary() {
        window.location.href = '/get-learner-profile';
    }

    function updateFileLabel() {
        var fileInput = document.getElementById('fileInput');
        var fileLabel = document.getElementById('fileLabel');
        
        // Check if a file has been selected
        if (fileInput.files.length > 0) {
            var fileName = fileInput.files[0].name; // Get the file name
            fileLabel.textContent = fileName; // Update the label text
        } else {
            fileLabel.textContent = 'Choose File'; // Default label text if no file selected
        }
    }
    
    function selectSubtitleUpload() {
        // Get the file input element
        var fileInput = document.getElementById('fileInput');
        var file = fileInput.files[0];

         // Get the responseMessage div to display errors or success messages
        var responseMessageDiv = document.getElementById('response');

        // If no file is selected, update the response div with an error message
        if (!file) {
            responseMessageDiv.textContent = "Please attach a file.";
            responseMessageDiv.style.color = "red"; // Set error message color
            return;
        }

        

        // Create FormData to send the file to the Flask server
        var formData = new FormData();
        formData.append("file", file);

        // Use fetch to send the file to Flask
        fetch('/upload-subtitles', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('File upload failed');
            }
            return response.json(); // Parse JSON response
        })
        .then(data => {

            console.log(data);
            // Handle the response (e.g., update the slider if needed)
            if (data.slider_values && data.slider_values.min !== undefined && data.slider_values.max !== undefined) {
                // Show the slider container
                document.getElementById('sliderContainer').style.display = 'block';

                // Initialize the slider with min and max from the response
                sliderInstance = $('#slider').ionRangeSlider({
                    type: 'double', // This makes it a range slider (two handles)
                    min: data.slider_values.min,
                    max: data.slider_values.max,
                    from: data.slider_values.min,  // Set the initial start of the range
                    to: data.slider_values.max,    // Set the initial end of the range
                    step: 1,
                    postfix: ' minutes',
                    grid: true

            });
            
            document.getElementById('submitButton').style.display = 'block';
            
            } else {
                // Log a warning if slider_values is not as expected
                console.error('Invalid slider values in response:', data);
                alert('Error: Invalid slider values');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('There was an error uploading the file.');
        });
    }

    function submitSubtitleUpload() {
        if (!sliderInstance) {
            console.error('Slider instance is not initialized.');
            var fromValue = 0;
            var toValue = 0;
        }
        else {
            var sliderValues = sliderInstance.data('ionRangeSlider').result;
            var fromValue = sliderValues.from;
            var toValue = sliderValues.to;
        }
        
        // Get the file input and create a FormData object
        var fileInput = document.getElementById('fileInput');
        var file = fileInput.files[0];
        var formData = new FormData();

        // Append file and slider values to FormData
        if (file) {
            formData.append("subtitle_file", file);
        }
        formData.append("slider_from", fromValue);
        formData.append("slider_to", toValue);
            
        fetch('/submit-subtitle-upload', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('File upload failed');
            }
            return response.json(); // Parse JSON response
        })
        .then(data => {
            document.getElementById('response').textContent = data.message;   
        })
        .catch(error => {
            console.error('Error:', error);
            alert('There was an error uploading the file.');
        });

    }   

    function takeScreenshot() {
        fetch('/take-screenshot', {
            method: 'POST'
        })
            .then(response => response.json())
            .then(data => {
                document.getElementById('response').textContent = data.message;
            })
            .catch(error => {
                document.getElementById('response').textContent = 'Failed to take screenshot.';
            });
    }

    let isRecording = false;

    function toggleScreenRecording() {
        const recordTile = document.querySelector('#record-content-options .tile[onclick="toggleScreenRecording()"]');
        const onStopRecordingSubmitLessonButton = document.getElementById('on-stop-recording-submit-lesson-button');  


        isRecording = !isRecording;
        recordTile.setAttribute('data-recording', isRecording);

        if (isRecording) {
            recordTile.querySelector('h2').textContent = 'STOP RECORDING SCREEN ';
            fetch('/begin-recording', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
                .then(response => response.json())
                .then(data => {
                    document.getElementById('response').textContent = 'Screen recording started.';
                })
                .catch(error => {
                    document.getElementById('response').textContent = 'Failed to start recording.';
                });
        } else {
            recordTile.querySelector('h2').textContent = 'BEGIN RECORDING SCREEN ';
            fetch('/stop-recording', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
                .then(response => response.json())
                .then(data => {
                    document.getElementById('response').textContent = 'Screen recording stopped.';

                    const subtitleFileName = 'placeholder.csv'; // this needs to come from the web page, and tkinter interface needs to be removed entirely
                    onStopRecordingSubmitLessonButton.style.display = 'block';

                    submitButton.setAttribute('data-subtitle', subtitleFileName);
                })
                .catch(error => {
                    document.getElementById('response').textContent = 'Failed to stop recording.';
                });
        }
    }
    function onStopRecordingSubmitLesson() {
        const onStopRecordingSubmitLessonButton = document.getElementById('on-stop-recording-submit-lesson-button');
        const subtitleFile = submitButton.getAttribute('data-subtitle');
        window.location.href = '/lesson?subtitle=${encodeURIComponent(subtitleFile)}&prompt_type=Summary';
    }

    function adjustBoundingBox() {
        fetch('/adjust-bounding-box', {
            method: 'POST'
        })
            .then(response => response.json())
            .then(data => {
                document.getElementById('response').textContent = data.message;
            })
            .catch(error => {
                document.getElementById('response').textContent = 'Failed to adjust bounding box.';
            });
    }
</script>
</body>
</html>
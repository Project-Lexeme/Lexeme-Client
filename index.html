<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Courier+New:wght@700&display=swap" rel="stylesheet">
    <!-- Include jQuery (required for ionRangeSlider) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- Include ionRangeSlider CSS and JS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ion-rangeslider/css/ion.rangeSlider.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/ion-rangeslider/js/ion.rangeSlider.min.js"></script>

    <title>Project Lexeme</title>
    <style>
        body {
            margin: 0;
            font-family: 'Courier', Arial, sans-serif;
            background-color: #f0f0f0;
            color: #333;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
        }

        #header {
            font-size: 72px;
            font-weight: bold;
            margin-bottom: 40px;
            color: #2c3e50;
        }

        .container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(2, 1fr);
            gap: 20px;
        }

        #lesson-prompt-options, #record-content-options, #subtitle-selection, #change-settings-options, #upload-content-options, #modify-configuration-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(2, 1fr);
            gap: 20px;
        }

        .tile {
            background-color: #fff;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .tile:hover {
            background-color: #dedede;
            transform: translateY(-5px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .tile h2 {
            margin-top: 0;
            color: #2c3e50;
        }

        .tile p {
            margin-bottom: 0;
            color: #7f8c8d;
        }

        #lesson-prompt-options, #record-content-options, #subtitle-selection, #change-settings-options, #upload-content-options, #modify-configuration-options {
            display: none;
        }

        #lesson-prompt-options .tile:last-child,
        #record-content-options .tile:last-child,
        #subtitle-selection .tile:last-child,
        #change-settings-options .tile:last-child,
        #upload-content-options .tile:last-child
        ,
        #modify-configuration-options .tile:last-child {
            grid-column: 2;
        }
        

        .dropdown-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
        }

        .dropdown-container select {
            padding: 10px;
            font-size: 16px;
            width: 300px;
        }

        .dropdown-container button {
            padding: 10px 20px;
            font-size: 16px;
            background-color: #2980b9;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        #response {
            margin-top: 20px;
            font-size: 18px;
            color: #2ecc71;
        }

        /*TEST TO CHANGE THIS*/
        #record-content-options .tile[data-recording="false"]:hover {
            background-color: #2ecc71; /* Green on hover */
            color: white;
        }

        #record-content-options .tile[data-recording="true"] {
            background-color: #e74c3c; /* Red when recording */
            color: white;
        }

        /* File input styling */
        .file-input-wrapper {
            display: inline-block;
            position: relative;
        }

        .file-input-wrapper input[type="file"] {
            position: absolute;
            top: 0;
            left: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-input-wrapper label {
            display: block;
            padding: 15px;
            background-color: #3498db;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .file-input-wrapper label:hover {
            background-color: #2980b9;
        }

        /* Slider container styling */
        #sliderContainer {
            display: none;
            margin-top: 20px;
        }

        .prompt-container {
            grid-column: 1 / span 3;
            background-color: #fff;
            border-radius: 8px;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }

        .prompt-container .dropdown-wrapper {
            display: inline-block;
            margin: 0 10px;
        }

        .custom-dropdown {
            background-color: #f0f0f0;
            border: none;
            border-radius: 5px;
            padding: 10px;
            font-family: 'Courier', Arial, sans-serif;
            font-size: 18px;
            appearance: none;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .custom-dropdown:hover {
            background-color: #dedede;
        }
    </style>
</head>
<body>
<div id="header">PROJECT LEXEME</div>
<div class="container">
    <div class="tile" onclick="showLessonOptions()">
        <h2>GENERATE LESSON</h2>
        <p>Get lessons from subtitles or vocabulary</p>
    </div>
    <div class="tile" onclick="showSettingsOptions()">
        <h2>CHANGE SETTINGS</h2>
        <p>Customize your experience</p>
    </div>
    <div class="tile" onclick="showRecordOptions()">
        <h2>RECORD CONTENT</h2>
        <p>Capture screenshots and record your screen</p>
    </div>
    <div class="tile" onclick="showUploadOptions()">
        <h2>UPLOAD FILES</h2>
        <p>Upload .srt files (or maybe CSV's in the future)</p>
    </div>
    <div class="tile">
        <h2>ALSO COMING SOON</h2>
        <p>More features</p>
    </div>
    <div class="tile">
        <h2>COMING, BUT NOT SO SOON</h2>
        <p>Expand capabilities</p>
    </div>
</div>

<div id="lesson-prompt-options">
    <div class="tile" onclick="getLessonFromSubtitles()"><h2>GET LESSON FROM SUBTITLES</h2></div>
    <div class="tile" onclick="getLessonFromVocabulary()"><h2>GET LESSON FROM VOCABULARY</h2></div>
    <div class="tile" onclick="goBack()"><h2>BACK</h2></div>
</div>

<div id="change-settings-options">
    <div class="tile" onclick="modifyConfigurationOptions()"><h2>MODIFY CONFIGURATIONS</h2></div>
    <div class="tile" onclick="viewGeneratedSubtitles()"><h2>VIEW GENERATED SUBTITLES</h2></div>
    <div class="tile" onclick="viewPromptsForLLM()"><h2>VIEW PROMPTS</h2></div>
    <div class="tile" onclick="goBack()"><h2>BACK</h2></div>
</div>

<div id="modify-configuration-options">
    <div class="tile" onclick="changeGeneralSettings()"><h2>GENERAL SETTINGS</h2></div>
    <div class="tile" onclick="changeOCRSettings()"><h2>OCR SETTINGS</h2></div>
    <div class="tile" onclick="changeServerSettings()"><h2>SERVER SETTINGS</h2></div>
    <div class="tile" onclick="changeProficiencySettings()"><h2>PROFICIENCY SETTINGS</h2></div>
    <div class="tile" onclick="goBackToChangeSettingsOptions()"><h2>BACK</h2></div>
</div>

<div id="subtitle-selection">
    <div class="prompt-container">
        <span style="font-size: 20px">I WANT TO GENERATE A</span>
        <div class="dropdown-wrapper">
            <select id="prompt-type-dropdown" class="custom-dropdown"></select>
        </div>
        <span style="font-size: 20px">WITH</span>
        <div class="dropdown-wrapper">
            <select id="subtitle-dropdown" class="custom-dropdown"></select>
        </div>
    </div>
    <div class="tile generate-tile" onclick="generate()">
        <h2>GENERATE</h2>
    </div>
    <div class="tile back-tile" onclick="goBackToLessonOptions()">
        <h2>BACK</h2>
    </div>
</div>

<div id="record-content-options">
    <div class="tile" onclick="takeScreenshot()"><h2>TAKE SCREENSHOT</h2></div>
    <div class="tile" onclick="toggleScreenRecording()"><h2>BEGIN RECORDING SCREEN</h2></div>
    <div class="tile" onclick="adjustBoundingBox()"><h2>ADJUST BOUNDING BOX</h2></div>
    <div class="tile" onclick="goBack()"><h2>BACK</h2></div>
</div>

<div id="upload-content-options">
    <div class="tile" id="fileInputWrapper">
        <div class="file-input-wrapper">
            <input type="file" id="fileInput" accept=".srt"  onchange="updateFileLabel(); uploadSubtitleFile();">
            <label for="fileInput" id="fileLabel">Choose a .SRT File</label>
        </div>
    </div>
    
    <div class="tile" id="submitButton" style="display: none;" onclick="submitSubtitleFile()">
        <h2>SUBMIT</h2> 
        
    </div>

    <!-- Slider container moved outside the tile but retains the tile style -->
    <div class="tile" id="sliderContainer" style="display: none;">
        <h2>Adjust the Slider</h2>
        <p>Set the value based on the uploaded file</p>
        <input type="text" id="slider" name="slider" />
    </div>

    <div class="tile" onclick="goBack()">
        <h2>BACK</h2>
    </div>
</div>

<div id="response"></div>

<script>
    function getLessonFromSubtitles() {
        fetch('/get-subtitle-files')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                // Populate subtitle dropdown
                const subtitleDropdown = document.getElementById('subtitle-dropdown');
                subtitleDropdown.innerHTML = ''; // Clear previous options
                data.choices.forEach(choice => {
                    const option = document.createElement('option');
                    option.value = choice;
                    option.textContent = choice;
                    subtitleDropdown.appendChild(option);
                });

                // Populate prompt type dropdown
                const promptTypeDropdown = document.getElementById('prompt-type-dropdown');
                promptTypeDropdown.innerHTML = ''; // Clear previous options
                data.prompt_types.forEach(type => {
                    const option = document.createElement('option');
                    option.value = type;
                    option.textContent = type;
                    promptTypeDropdown.appendChild(option);
                });

                // Hide lesson prompt options and show subtitle selection
                document.getElementById('lesson-prompt-options').style.display = 'none';
                document.getElementById('subtitle-selection').style.display = 'grid';
            })
            .catch(error => {
                console.error('Error fetching subtitle files:', error);
                document.getElementById('response').textContent = 'Error fetching subtitle files.';
            });
    }

    function modifyConfiguration() {
        fetch('/open-config-file', {
            method: 'POST'
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to open config file');
                } else {
                    document.getElementById('response').textContent = 'Modifying Configurations';
                }
            })
            .catch(error => console.error('Error:', error));
    }

    function viewGeneratedSubtitles() {
        fetch('/open-subtitles-folder', {
            method: 'POST'
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to open subtitles folder');
                } else {
                    document.getElementById('response').textContent = 'Viewing Generated Subtitles';
                }
            })
            .catch(error => console.error('Error:', error));
    }

    function viewPromptsForLLM() {
        fetch('/open-prompt-directory', {
            method: 'POST'
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to open prompt directory');
                } else {
                    document.getElementById('response').textContent = 'Opening Prompt Directory';
                }
            })
            .catch(error => console.error('Error:', error));
    }

    function generate() {
        const subtitleDropdown = document.getElementById('subtitle-dropdown');
        const promptTypeDropdown = document.getElementById('prompt-type-dropdown');

        const selectedSubtitle = subtitleDropdown.value;
        const selectedPromptType = promptTypeDropdown.value;

        fetch('/generate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                subtitle: selectedSubtitle,
                prompt_type: selectedPromptType
            })
        })
            .then(response => response.json())
            .then(data => {
                document.getElementById('response').textContent = 'Lesson generated successfully!';
                window.location.href = `/lesson?subtitle=${encodeURIComponent(selectedSubtitle)}&prompt_type=${encodeURIComponent(selectedPromptType)}`;
                // Additional handling of lesson data can be added here
            })
            .catch(error => {
                console.error('Error generating lesson:', error);
                document.getElementById('response').textContent = 'Error generating lesson.';
            });
    }

    function showSettingsOptions() {
        document.querySelector('.container').style.display = 'none';
        const settingsOptions = document.getElementById('change-settings-options');
        settingsOptions.style.display = 'grid';
    }

    function modifyConfigurationOptions() {
        document.getElementById('change-settings-options').style.display = 'none';
        const configurationOptions = document.getElementById('modify-configuration-options');
        configurationOptions.style.display = 'grid';
    }

    function showRecordOptions() {
        document.querySelector('.container').style.display = 'none';
        const recordOptions = document.getElementById('record-content-options');
        recordOptions.style.display = 'grid';
    }

    function showLessonOptions() {
        document.querySelector('.container').style.display = 'none';
        const lessonOptions = document.getElementById('lesson-prompt-options');
        lessonOptions.style.display = 'grid';
    }
    function showUploadOptions() {
        document.querySelector('.container').style.display = 'none';
        const settingsOptions = document.getElementById('upload-content-options');
        settingsOptions.style.display = 'grid';
    }

    function goBack() {
        document.getElementById('lesson-prompt-options').style.display = 'none';
        document.getElementById('record-content-options').style.display = 'none';
        document.getElementById('change-settings-options').style.display = 'none';
        document.getElementById('upload-content-options').style.display = 'none';
        document.getElementById('modify-configuration-options').style.display = 'none';
        document.getElementById('response').textContent = " ";
        document.querySelector('.container').style.display = 'grid';
    }

    function goBackToLessonOptions() {
        document.getElementById('subtitle-selection').style.display = 'none';
        document.getElementById('lesson-prompt-options').style.display = 'grid';
        document.getElementById('response').textContent = " ";
    }

    function goBackToChangeSettingsOptions() {
        document.getElementById('modify-configuration-options').style.display = 'none';
        document.getElementById('change-settings-options').style.display = 'grid';
        document.getElementById('response').textContent = " ";
    }

    function getLessonFromVocabulary() {
        window.location.href = '/get-learner-profile';
    }

    function updateFileLabel() {
        var fileInput = document.getElementById('fileInput');
        var fileLabel = document.getElementById('fileLabel');
        
        // Check if a file has been selected
        if (fileInput.files.length > 0) {
            var fileName = fileInput.files[0].name; // Get the file name
            fileLabel.textContent = fileName; // Update the label text
        } else {
            fileLabel.textContent = 'Choose File'; // Default label text if no file selected
        }
    }
    
    function uploadSubtitleFile() {
        // Get the file input element
        var fileInput = document.getElementById('fileInput');
        var file = fileInput.files[0];

         // Get the responseMessage div to display errors or success messages
        var responseMessageDiv = document.getElementById('response');

        // If no file is selected, update the response div with an error message
        if (!file) {
            responseMessageDiv.textContent = "Please attach a file.";
            responseMessageDiv.style.color = "red"; // Set error message color
            return;
        }

        

        // Create FormData to send the file to the Flask server
        var formData = new FormData();
        formData.append("file", file);

        // Use fetch to send the file to Flask
        fetch('/upload-subtitles', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('File upload failed');
            }
            return response.json(); // Parse JSON response
        })
        .then(data => {

            console.log(data);
            // Handle the response (e.g., update the slider if needed)
            if (data.slider_values && data.slider_values.min !== undefined && data.slider_values.max !== undefined) {
                // Show the slider container
                document.getElementById('sliderContainer').style.display = 'block';

                // Initialize the slider with min and max from the response
                $('#slider').ionRangeSlider({
                    type: 'double', // This makes it a range slider (two handles)
                    min: data.slider_values.min,
                    max: data.slider_values.max,
                    from: data.slider_values.min,  // Set the initial start of the range
                    to: data.slider_values.max,    // Set the initial end of the range
                    step: 1,
                    postfix: ' minutes',
                    grid: true

            });
            
            document.getElementById('submitButton').style.display = 'block';
            
            } else {
                // Log a warning if slider_values is not as expected
                console.error('Invalid slider values in response:', data);
                alert('Error: Invalid slider values');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('There was an error uploading the file.');
        });
    }

    function takeScreenshot() {
        fetch('/take-screenshot', {
            method: 'POST'
        })
            .then(response => response.json())
            .then(data => {
                document.getElementById('response').textContent = data.message;
            })
            .catch(error => {
                document.getElementById('response').textContent = 'Failed to take screenshot.';
            });
    }

    let isRecording = false;

    function toggleScreenRecording() {
        const recordTile = document.querySelector('#record-content-options .tile[onclick="toggleScreenRecording()"]');

        isRecording = !isRecording;
        recordTile.setAttribute('data-recording', isRecording);

        if (isRecording) {
            recordTile.querySelector('h2').textContent = 'STOP RECORDING SCREEN ';
            fetch('/begin-recording', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
                .then(response => response.json())
                .then(data => {
                    document.getElementById('response').textContent = 'Screen recording started.';
                })
                .catch(error => {
                    document.getElementById('response').textContent = 'Failed to start recording.';
                });
        } else {
            recordTile.querySelector('h2').textContent = 'BEGIN RECORDING SCREEN ';
            fetch('/stop-recording', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
                .then(response => response.json())
                .then(data => {
                    document.getElementById('response').textContent = 'Screen recording stopped.';
                })
                .catch(error => {
                    document.getElementById('response').textContent = 'Failed to stop recording.';
                });
        }
    }

    function adjustBoundingBox() {
        fetch('/adjust-bounding-box', {
            method: 'POST'
        })
            .then(response => response.json())
            .then(data => {
                document.getElementById('response').textContent = data.message;
            })
            .catch(error => {
                document.getElementById('response').textContent = 'Failed to adjust bounding box.';
            });
    }
</script>
</body>
</html>